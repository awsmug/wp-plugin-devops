#!/bin/bash

# Setting up directory variables
export SCRIPT_PATH=$(pwd)
RELATIVE_LINK_DIR="$(dirname "$(readlink "$0")")"
VENDOR_BIN_DIR="`dirname \"$0\"`"              # relative
VENDOR_BIN_DIR="`( cd \"$VENDOR_BIN_DIR\" && pwd )`"  # absolutized and normalized
export BIN_DIR="`( cd \"$VENDOR_BIN_DIR\" && cd \"$RELATIVE_LINK_DIR\" && pwd )`"
export DEVOPS_PATH=$(dirname $BIN_DIR)

export SERVER_HOST="localhost"
export SERVER_IP="10.221.50.20"

# Setting up docker variables
CONTAINER_PREFIX=$(basename ${SCRIPT_PATH})
CONTAINER_PREFIX=${CONTAINER_PREFIX// /}
export CONTAINER_PREFIX=${CONTAINER_PREFIX//-/}_
export WP_CONTAINER_NAME="${CONTAINER_PREFIX}wp_1"

# Setting up WP variables
export PLUGIN_PATH=$SCRIPT_PATH
export PLUGIN_SLUG=$(basename $PLUGIN_PATH)
export REMOTE_PLUGIN_PATH=${PLUGIN_PATH}/wordpress/wp-content/plugins/

# Setting up files
if [ -f vendor/awsmug/wp-plugin-devops/bin/docker/nginx/default.conf.dist ]; then
    # As Composer depency
    export NGINX_CONF=${PLUGIN_PATH}/vendor/awsmug/wp-plugin-devops/bin/docker/nginx/default.conf.dist
    export NGINX_CONF_DEST=${PLUGIN_PATH}/vendor/awsmug/wp-plugin-devops/bin/docker/nginx/default.conf
    export DOCKER_COMPOSE_FILE=${PLUGIN_PATH}/vendor/awsmug/wp-plugin-devops/docker-compose.yml.dist
else
    # Direct variant
    export NGINX_CONF=${PLUGIN_PATH}/bin/docker/nginx/default.conf.dist
    export NGINX_CONF_DEST=${PLUGIN_PATH}/bin/docker/nginx/default.conf
    export DOCKER_COMPOSE_FILE=${PLUGIN_PATH}/docker-compose.yml.dist
fi

export DOCKER_COMPOSE_DEST=${PLUGIN_PATH}/docker-compose.yml

function add_to_gitignore {
    echo "###" >> $1
    echo "# Automatinc added files from WP Plugin Devops" >> $1
    echo "###" >> $1
    echo "composer.lock" >> $1
    echo "test" >> $1
    echo "webserver" >> $1
    echo "vendor" >> $1
    echo "wordpress" >> $1
}

# Running command
if [ "$1" = "start" ]; then
    if [ ! -z "$2" ]; then
        export SERVER_HOST=$2

        cp ${DOCKER_COMPOSE_FILE} ${DOCKER_COMPOSE_DEST}
        cp ${NGINX_CONF} ${NGINX_CONF_DEST}

        echo ${DOCKER_COMPOSE_FILE}
        echo ${DOCKER_COMPOSE_DEST}

        sed -i -e 's/wordpress.dev/'${SERVER_HOST}'/' ${DOCKER_COMPOSE_DEST}
        sed -i -e 's/wordpress.dev/'${SERVER_HOST}'/' ${NGINX_CONF_DEST}

        read -p "You have set a hostname. Do you want to add it to /etc/hosts on your System? (y/n): " add_hosts

        if [ "y" = $add_hosts ]; then
            echo "${SERVER_IP} ${SERVER_HOST}" >> /etc/hosts
        fi

        rm ${NGINX_CONF_DEST}-e
        rm ${DOCKER_COMPOSE_DEST}-e
    fi

    $BIN_DIR/docker/start.sh

elif [ "$1" = "stop" ]; then
    $BIN_DIR/docker/stop.sh

elif [ "$1" = "test" ]; then
    $BIN_DIR/docker/test.sh $2

elif [ "$1" = "sync" ]; then
    $BIN_DIR/docker/sync.sh

elif [ "$1" = "clean" ]; then
    $BIN_DIR/docker/clean.sh

elif [ "$1" = "install" ]; then
    $BIN_DIR/docker/install.sh

else
    echo "Usage: $(basename $0) <start [hostname]|stop|test|clean>"
    exit 1
fi