#!/bin/bash

# Setting up directory variables
export SCRIPT_PATH=$(pwd)
RELATIVE_DIR="$(dirname "$(readlink "$0")")"
BIN_PATH="`dirname \"$0\"`"              # relative
BIN_PATH="`( cd \"$BIN_PATH\" && pwd )`"  # absolutized and normalized
export BIN_DIR="`( cd \"$BIN_PATH\" && cd \"$RELATIVE_DIR\" && pwd )`"
export DEVOPS_PATH="${SCRIPT_PATH}/devops"

echo $BIN_DIR
echo $BIN_PATH

# Setting up docker variables
CONTAINER_PREFIX=$(basename ${SCRIPT_PATH})
CONTAINER_PREFIX=${CONTAINER_PREFIX// /}
export CONTAINER_PREFIX=${CONTAINER_PREFIX//-/}_
export WP_CONTAINER_NAME="${CONTAINER_PREFIX}wp_1"

# Setting up WP variables
export PLUGIN_PATH=$SCRIPT_PATH
export PLUGIN_SLUG=$(basename $PLUGIN_PATH)
export REMOTE_PLUGIN_PATH=${PLUGIN_PATH}/wordpress/wp-content/plugins/


# Setting up files
if [ -d vendor/awsmug/wp-plugin-devops ]; then
    export DOCKER_COMPOSE_FILE=${PLUGIN_PATH}/vendor/awsmug/wp-plugin-devops/devops/docker-compose.yml.dist
else
    export DOCKER_COMPOSE_FILE=${PLUGIN_PATH}/devops/docker-compose.yml.dist
fi

export DOCKER_COMPOSE_DEST=${PLUGIN_PATH}/docker-compose.yml

# Running command
if [ "$1" = "start" ]; then
    source $BIN_DIR/docker/start.sh

elif [ "$1" = "stop" ]; then
    source $BIN_DIR/docker/stop.sh

elif [ "$1" = "test" ]; then
    source $BIN_DIR/docker/test.sh $2

elif [ "$1" = "sync" ]; then
    source $BIN_DIR/docker/sync.sh

elif [ "$1" = "clean" ]; then
    source $BIN_DIR/docker/clean.sh

elif [ "$1" = "install" ]; then
    source $BIN_DIR/docker/install.sh

else
    echo "Usage: $(basename $0) <start|stop|test|clean|install>"
    exit 1
fi